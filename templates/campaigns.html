<!DOCTYPE html>
<html>
<head>
  <title>Campaigns</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    h2 {
      color: #2c3e50;
      margin: 0;
      font-size: 2.2em;
      font-weight: 600;
    }

    /* Tab Styles */
    .tabs-container {
      margin-bottom: 30px;
    }

    .tabs-nav {
      display: flex;
      border-bottom: 3px solid #e9ecef;
      margin-bottom: 25px;
    }

    .tab-button {
      padding: 15px 30px;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: 600;
      color: #6c757d;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      margin-right: 20px;
      position: relative;
    }

    .tab-button:hover {
      color: #667eea;
      background: rgba(102, 126, 234, 0.05);
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: rgba(102, 126, 234, 0.1);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
    
    .upload-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      border: 2px solid #e9ecef;
    }
    
    .upload-title {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .upload-form {
      display: flex;
      gap: 12px;
      align-items: end;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 180px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #495057;
      font-size: 14px;
    }
    
    .form-group input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    
    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .file-input-wrapper:hover {
      border-color: #667eea;
    }
    
    .file-input-wrapper {
  cursor: pointer;
}

.file-input-wrapper input[type=file] {
  position: absolute;
  left: 0;
  top: 0;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  z-index: 2;
}

.file-input-text {
  pointer-events: none;
  position: relative;
  z-index: 1;
}
    
    .file-input-text {
      color: #6c757d;
      font-size: 14px;
      pointer-events: none;
    }
    
    .upload-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    
    .upload-btn:hover {
      background: #5a67d1;
    }
    
    .upload-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .search-container {
      margin-bottom: 25px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .search-input {
      padding: 12px 20px;
      border: 2px solid #e9ecef;
      border-radius: 25px;
      font-size: 16px;
      flex: 1;
      max-width: 400px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .clear-btn {
      padding: 12px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .clear-btn:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid #f8f9fa;
      font-size: 14px;
      vertical-align: middle;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: #e3f2fd;
      transform: scale(1.01);
      transition: all 0.2s;
    }
    
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s;
    }
    
    .btn-view {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      color: white;
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #ff7675, #e17055);
      color: white;
    }
    
    .btn-send {
      background: linear-gradient(135deg, #00b894, #00a085);
      color: white;
    }

    .btn-merge {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-approved {
      background: linear-gradient(135deg, #00b894, #00a085);
      color: white;
    }
    
    .status-pending {
      background: linear-gradient(135deg, #fdcb6e, #e17055);
      color: white;
    }
    
    .status-draft {
      background: linear-gradient(135deg, #fd79a8, #e84393);
      color: white;
    }
    
    .pagination {
      margin-top: 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    
    .pagination button {
      padding: 10px 15px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #667eea;
      color: white;
    }
    
    .pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .pagination .current {
      background: #667eea;
      color: white;
    }
    
    .records-info {
      margin-bottom: 15px;
      color: #6c757d;
      font-size: 14px;
      font-weight: 500;
    }
    
    .no-results {
      text-align: center;
      padding: 60px;
      color: #6c757d;
    }
    
    .no-results h3 {
      color: #495057;
      margin-bottom: 10px;
    }
    
    .flash-messages {
      margin-bottom: 20px;
    }
    
    .flash-message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .flash-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .flash-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .campaign-count {
      font-size: 12px;
      color: #6c757d;
      font-weight: normal;
      margin-left: 10px;
    }

    
.merge-popup-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  display: none;
  z-index: 1000;
}

.merge-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
}

.merge-popup h3 {
  color: #2c3e50;
  margin-bottom: 20px;
}

.merge-popup h4 {
  color: #155724;
  margin-bottom: 15px;
  font-size: 1em;
}

.dropdown-container {
  position: relative;
  margin-bottom: 15px;
}

.dropdown-button {
  width: 100%;
  padding: 12px 16px;
  background: white;
  border: 2px solid #c3e6cb;
  border-radius: 8px;
  font-size: 15px;
  color: #495057;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
  min-height: 50px;
}

.dropdown-button:hover {
  border-color: #28a745;
  background: #f8f9fa;
}

.dropdown-button.active {
  border-color: #28a745;
  background: #f8f9fa;
}

.dropdown-arrow {
  transition: transform 0.3s;
}

.dropdown-button.active .dropdown-arrow {
  transform: rotate(180deg);
}

.dropdown-menu {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 2px solid #c3e6cb;
  border-top: none;
  border-radius: 0 0 8px 8px;
  max-height: 250px;
  overflow-y: auto;
  z-index: 100;
  display: none;
}

.dropdown-menu.show {
  display: block;
}

.dropdown-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid #f1f3f4;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.2s;
}

.dropdown-item:hover {
  background-color: #f8f9fa;
}

.dropdown-item:last-child {
  border-bottom: none;
}

.campaign-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.campaign-name {
  font-weight: 500;
  color: #2c3e50;
}

.campaign-details {
  font-size: 12px;
  color: #6c757d;
}

.campaign-checkbox {
  margin-left: 10px;
  transform: scale(1.2);
}

.selected-campaigns {
  margin-top: 20px;
}

.selected-list {
  background: white;
  border: 2px solid #c3e6cb;
  border-radius: 8px;
  min-height: 80px;
  padding: 15px;
  max-height: 200px;
  overflow-y: auto;
}

.selected-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 12px;
  background: #e8f5e8;
  border: 1px solid #c3e6cb;
  border-radius: 6px;
  margin-bottom: 8px;
}

.selected-item:last-child {
  margin-bottom: 0;
}

.remove-btn {
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 8px;
  font-size: 12px;
  cursor: pointer;
  transition: background-color 0.3s;
}

.remove-btn:hover {
  background: #c82333;
}

.empty-selection {
  color: #6c757d;
  font-style: italic;
  text-align: center;
  padding: 20px;
}

.selected-count {
  font-weight: 600;
  color: #28a745;
}

.popup-buttons {
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 20px;
}

.btn-popup {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
}

.btn-popup-merge {
  background: #28a745;
  color: white;
}

.btn-popup-merge:disabled {
  background: #6c757d;
  cursor: not-allowed;
}

.btn-popup-cancel {
  background: #6c757d;
  color: white;
}
/* Add this CSS to your existing styles */
.btn-merge-header {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 16px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  white-space: nowrap;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
}

.btn-merge-header:hover {
  background: linear-gradient(135deg, #218838, #1e9e8a);
  transform: translateY(-50%) translateY(-2px);
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.btn-merge-header:active {
  transform: translateY(-50%) translateY(0);
}

/* Add to existing CSS in both templates */
.upload-form {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr auto;
  gap: 12px;
  align-items: end;
}

@media (max-width: 768px) {
  .upload-form {
    grid-template-columns: 1fr;
  }
}

.merge-controls {
  display: grid;
  grid-template-columns: 1fr 1fr auto;
  gap: 15px;
  align-items: end;
  margin-top: 20px;
}

@media (max-width: 768px) {
  .merge-controls {
    grid-template-columns: 1fr;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="header">
      <h2>📁 Campaign Management <span class="campaign-count">({{ campaigns|length }} Distributed List)</span></h2>
    </div>
    
    <!-- Tabs Navigaton -->
    <div class="tabs-container">
      <div class="tabs-nav">
        <button class="tab-button active" onclick="switchTab('campaigns')">
          📋 Manage Distributed Lists
        </button>
        <button class="tab-button" onclick="switchTab('merge')">
          🔄 Manage Campaigns
        </button>
      </div>

      <!-- Campaigns Tab Content -->
      <div id="campaigns-tab" class="tab-content active">
        <!-- CSV Upload Section -->
        <div class="upload-section">
          <div class="upload-title">
            <span>📤</span>
            Upload New Distributed List
          </div>
          
          <form method="POST" action="{{ url_for('upload_csv') }}" enctype="multipart/form-data" class="upload-form" id="uploadForm">
            <div class="form-group">
              <label for="campaign_name">Distributed list Name</label>
              <input type="text" id="campaign_name" name="campaign_name" placeholder="Enter List name..." required>
            </div>

            <div class="form-group">
              <label for="campaign_description">Description (Optional)</label>
              <input type="text" id="campaign_description" name="campaign_description" placeholder="Brief description of this list...">
            </div>
            
            <div class="form-group">
              <label>CSV File</label>
              <div class="file-input-wrapper">
                <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
                  <span class="file-input-text" id="fileText">Choose file...</span>
              </div>
            </div>
            
            <button type="submit" class="upload-btn" id="uploadBtn">
              <span>📁</span>
              Upload
            </button>
          </form>
        </div>

        <!-- Search and Filter -->
        <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="🔍 Search Distributed List by name, status..." />
          <button class="clear-btn" onclick="clearSearch()">Clear</button>
        </div>
        
        <div class="records-info">
          Showing <span id="recordsCount">0</span> Lists
        </div>
        
        <!-- Add this before the table-container div
<div class="merge-controls" style="margin-bottom: 20px;">
  <button type="button" class="btn btn-merge" onclick="showMergePopup()">
    📄 Merge Campaigns
  </button>
</div> -->

        
        <!-- Campaigns Table -->
        <div class="table-container">
          <table id="campaignsTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>List Name</th>
                <th>Description</th>
                <th>Status</th>
                <th>Profile Count</th>
                    <th style="position: relative; padding-right: 120px;">
      ACTIONS
      <button type="button" class="btn-merge-header" onclick="showMergePopup()" title="Merge Campaigns">
        📄 Merge Campaigns
      </button>
    </th>
              </tr>
            </thead>
            <tbody id="tableBody">
              {% for c in campaigns %}
              <tr>
                <td><strong>#{{ c[0] }}</strong></td>
                <td>{{ c[1] }}</td>
                <td>
                  <span style="color: #6c757d; font-size: 13px; max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ c[3] or 'No description' }}">
                    {{ c[3] or 'No description' }}
                  </span>
                </td>
                <td>
                  <span class="status-badge 
                    {% if c[2] == 'approved' %}status-approved
                    {% elif c[2] == 'pending' %}status-pending
                    {% else %}status-draft{% endif %}">{{ c[2] }}</span>
                </td>
                <td><strong>{{ c[4] if c[4] else 0 }}</strong></td>
                <td>
                  <div class="actions">
                    <a href="{{ url_for('campaign_detail', campaign_id=c[0]) }}" class="btn btn-view">👥 View Profiles</a>
                    <form method="POST" action="{{ url_for('delete_campaign', campaign_id=c[0]) }}" style="display:inline;">
                      <button type="submit" class="btn btn-delete" onclick="return confirm('⚠️ Are you sure you want to delete this campaign and all its profiles?')">🗑️ Delete</button>
                    </form>
                    {% if c[2] == 'approved' %}
                    <form method="POST" action="{{ url_for('send_to_n8n', campaign_id=c[0]) }}" style="display:inline;">
                      <button type="submit" class="btn btn-send" onclick="return confirm('Send approved campaign?')">🚀 Process</button>
                    </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          
          <div id="noResults" class="no-results" style="display: none;">
            <h3>No Lists found</h3>
            <p>Try adjusting your search criteria or upload a new campaign</p>
          </div>
        </div>
        
        <!-- Pagination -->
        <div class="pagination" id="pagination">
          <button id="prevBtn" onclick="changePage(-1)">← Previous</button>
          <span id="pageInfo">Page 1 of 1</span>
          <button id="nextBtn" onclick="changePage(1)">Next →</button>
        </div>
      </div>

      <!-- Merge Tab Content -->
      <div id="merge-tab" class="tab-content">
        <div style="text-align: center; padding: 40px;">
          <a href="{{ url_for('merge_campaigns_page') }}" class="btn btn-merge">
            🔄 Go to Merge Campaigns Page
          </a>
          <p style="margin-top: 20px; color: #6c757d;">
            Select and merge multiple campaigns into one unified campaign
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const recordsPerPage = 10;
    let filteredRows = [];
    let allRows = [];
    let selectedCampaigns = new Map();
let allCampaigns = [];
let dropdownOpen = false;

function showMergePopup() {
  loadAvailableCampaigns();
  document.getElementById('mergePopupOverlay').style.display = 'block';
}

function closeMergePopup() {
  document.getElementById('mergePopupOverlay').style.display = 'none';
  selectedCampaigns.clear();
  dropdownOpen = false;
  document.getElementById('mergedCampaignName').value = '';
  updateSelectedDisplay();
}

// Replace the loadAvailableCampaigns function in your campaigns.html with this fixed version:

function loadAvailableCampaigns() {
  // Get campaigns from the current table
  const tableRows = document.querySelectorAll('#tableBody tr');
  allCampaigns = [];
  
  tableRows.forEach(row => {
    const cells = row.cells;
    const id = parseInt(cells[0].textContent.trim().replace('#', ''));
    const name = cells[1].textContent.trim();
    const description = cells[2].textContent.trim(); // Description column
    const status = cells[3].querySelector('.status-badge').textContent.trim(); // Status from badge
    const profileCount = parseInt(cells[4].textContent.trim()) || 0; // ✅ CORRECT INDEX (4)
    
    allCampaigns.push({
      id: id,
      name: name,
      status: status,
      description: description,
      profile_count: profileCount
    });
  });
  
  renderDropdownItems();
}

// Also update the renderDropdownItems function to show description:
function renderDropdownItems() {
  const dropdownMenu = document.getElementById('dropdownMenu');
  
  if (allCampaigns.length === 0) {
    dropdownMenu.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">No campaigns available</div>';
    return;
  }
  
  dropdownMenu.innerHTML = allCampaigns.map(campaign => `
    <div class="dropdown-item" onclick="toggleCampaignSelection(${campaign.id})">
      <div class="campaign-info">
        <div class="campaign-name">${campaign.name}</div>
        <div class="campaign-details">
          ID: ${campaign.id} • Status: ${campaign.status} • Profiles: ${campaign.profile_count}
          ${campaign.description && campaign.description !== 'No description' ? ' • ' + campaign.description.substring(0, 50) + (campaign.description.length > 50 ? '...' : '') : ''}
        </div>
      </div>
      <input type="checkbox" class="campaign-checkbox" id="campaign_${campaign.id}" ${selectedCampaigns.has(campaign.id) ? 'checked' : ''}>
    </div>
  `).join('');
}

function renderDropdownItems() {
  const dropdownMenu = document.getElementById('dropdownMenu');
  
  if (allCampaigns.length === 0) {
    dropdownMenu.innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">No campaigns available</div>';
    return;
  }
  
  dropdownMenu.innerHTML = allCampaigns.map(campaign => `
    <div class="dropdown-item" onclick="toggleCampaignSelection(${campaign.id})">
      <div class="campaign-info">
        <div class="campaign-name">${campaign.name}</div>
        <div class="campaign-details">
          ID: ${campaign.id} • Status: ${campaign.status} • Profiles: ${campaign.profile_count}
        </div>
      </div>
      <input type="checkbox" class="campaign-checkbox" id="campaign_${campaign.id}" ${selectedCampaigns.has(campaign.id) ? 'checked' : ''}>
    </div>
  `).join('');
}

function toggleDropdown() {
  dropdownOpen = !dropdownOpen;
  const dropdown = document.getElementById('campaignDropdown');
  const menu = document.getElementById('dropdownMenu');
  
  if (dropdownOpen) {
    dropdown.classList.add('active');
    menu.classList.add('show');
  } else {
    dropdown.classList.remove('active');
    menu.classList.remove('show');
  }
}

function toggleCampaignSelection(campaignId) {
  const campaign = allCampaigns.find(c => c.id === campaignId);
  if (!campaign) return;
  
  if (selectedCampaigns.has(campaignId)) {
    selectedCampaigns.delete(campaignId);
  } else {
    selectedCampaigns.set(campaignId, campaign);
  }
  
  updateSelectedDisplay();
  renderDropdownItems(); // Update checkboxes
}

function removeCampaign(campaignId) {
  selectedCampaigns.delete(campaignId);
  updateSelectedDisplay();
  renderDropdownItems();
}

function updateSelectedDisplay() {
  const selectedList = document.getElementById('selectedList');
  const selectedCount = document.getElementById('selectedCount');
  const mergeBtn = document.getElementById('performMergeBtn');
  
  selectedCount.textContent = selectedCampaigns.size;
  
  if (selectedCampaigns.size === 0) {
    selectedList.innerHTML = '<div class="empty-selection">No campaigns selected</div>';
    mergeBtn.disabled = true;
  } else {
    selectedList.innerHTML = Array.from(selectedCampaigns.values()).map(campaign => `
      <div class="selected-item">
        <div class="campaign-info">
          <div class="campaign-name">${campaign.name}</div>
          <div class="campaign-details">ID: ${campaign.id} • Profiles: ${campaign.profile_count}</div>
        </div>
        <button class="remove-btn" onclick="removeCampaign(${campaign.id})" type="button">✕</button>
      </div>
    `).join('');
    
    mergeBtn.disabled = selectedCampaigns.size < 2;
  }
}

// Replace the performMerge function in your campaigns.html with this fixed version:

function performMerge() {
  const campaignName = document.getElementById('mergedCampaignName').value.trim();
  const campaignDescription = document.getElementById('merged_campaign_description').value.trim(); // ✅ GET DESCRIPTION
  
  if (!campaignName) {
    alert('Please enter a name for the merged campaign');
    return;
  }
  
  if (selectedCampaigns.size < 2) {
    alert('Please select at least 2 campaigns to merge');
    return;
  }
  
  if (!confirm(`Are you sure you want to merge ${selectedCampaigns.size} campaigns into "${campaignName}"?\n\nOriginal campaigns will be deleted.`)) {
    return;
  }
  
  // Create form and submit
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '/merge_campaigns';
  
  // Add campaign IDs
  selectedCampaigns.forEach((campaign, id) => {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'campaign_ids[]';
    input.value = id;
    form.appendChild(input);
  });
  
  // Add campaign name
  const nameInput = document.createElement('input');
  nameInput.type = 'hidden';
  nameInput.name = 'merged_campaign_name';
  nameInput.value = campaignName;
  form.appendChild(nameInput);
  
  // ✅ ADD CAMPAIGN DESCRIPTION
  const descriptionInput = document.createElement('input');
  descriptionInput.type = 'hidden';
  descriptionInput.name = 'merged_campaign_description';
  descriptionInput.value = campaignDescription;
  form.appendChild(descriptionInput);
  
  document.body.appendChild(form);
  form.submit();
}

// Close popup when clicking outside
document.addEventListener('click', function(event) {
  const overlay = document.getElementById('mergePopupOverlay');
  if (overlay && event.target === overlay) {
    closeMergePopup();
  }
});

    function switchTab(tabName) {
  // If clicking on merge tab, redirect to merge campaigns page
  if (tabName === 'merge') {
    window.location.href = "{{ url_for('merge_campaigns_page') }}";
    return;
  }
  
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Remove active class from all tab buttons
  document.querySelectorAll('.tab-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Show selected tab content
  document.getElementById(tabName + '-tab').classList.add('active');
  
  // Add active class to clicked button
  event.target.classList.add('active');
}

    function initializeTable() {
      const tableBody = document.getElementById('tableBody');
      allRows = Array.from(tableBody.getElementsByTagName('tr'));
      filteredRows = [...allRows];
      updateDisplay();
    }

    function searchTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const tableBody = document.getElementById('tableBody');
      const rows = Array.from(tableBody.getElementsByTagName('tr'));
      
      filteredRows = rows.filter(row => {
        const text = row.textContent.toLowerCase();
        return text.includes(searchTerm);
      });
      
      currentPage = 1;
      updateDisplay();
    }

    function updateDisplay() {
      const startIndex = (currentPage - 1) * recordsPerPage;
      const endIndex = startIndex + recordsPerPage;
      const totalPages = Math.ceil(filteredRows.length / recordsPerPage);
      
      // Hide all rows
      allRows.forEach(row => row.style.display = 'none');
      
      // Show current page rows
      const currentRows = filteredRows.slice(startIndex, endIndex);
      currentRows.forEach(row => row.style.display = '');
      
      // Update pagination
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
      document.getElementById('pageInfo').textContent = totalPages > 0 ? `Page ${currentPage} of ${totalPages}` : 'Page 0 of 0';
      
      // Update records count
      document.getElementById('recordsCount').textContent = filteredRows.length;
      
      // Show/hide no results message
      const noResults = document.getElementById('noResults');
      const table = document.getElementById('campaignsTable');
      if (filteredRows.length === 0) {
        noResults.style.display = 'block';
        table.style.display = 'none';
      } else {
        noResults.style.display = 'none';
        table.style.display = 'table';
      }
    }

    function changePage(direction) {
      const totalPages = Math.ceil(filteredRows.length / recordsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        updateDisplay();
      }
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      filteredRows = [...allRows];
      currentPage = 1;
      updateDisplay();
    }

    // File input handling
    // File input handling
document.getElementById('csv_file').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    document.getElementById('fileText').textContent = file.name;
    document.getElementById('fileText').style.color = '#495057'; // Show file is selected
  } else {
    document.getElementById('fileText').textContent = 'Choose file...';
    document.getElementById('fileText').style.color = '#6c757d'; // Default color
  }
});

    // Form validation and submission
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      const campaignName = document.getElementById('campaign_name').value.trim();
      const csvFile = document.getElementById('csv_file').files[0];
      
      if (!campaignName) {
        alert('Please enter a campaign name');
        e.preventDefault();
        return;
      }
      
      if (!csvFile) {
        alert('Please select a CSV file');
        e.preventDefault();
        return;
      }
      
      if (!csvFile.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a valid CSV file');
        e.preventDefault();
        return;
      }
      
      // Show loading state
      const btn = document.getElementById('uploadBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>⏳</span> Uploading...';
    });

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', searchTable);
    document.getElementById('searchInput').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        searchTable();
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initializeTable);
  </script>

  <!-- Merge Popup -->
<div class="merge-popup-overlay" id="mergePopupOverlay">
  <div class="merge-popup">
    <h3>📄 Merge Campaigns</h3>
    
    <div class="campaign-selector">
      <h4>📋 Available Campaigns</h4>
      
      <div class="dropdown-container">
        <div class="dropdown-button" id="campaignDropdown" onclick="toggleDropdown()">
          <span>Select campaigns to merge...</span>
          <span class="dropdown-arrow">▼</span>
        </div>
        
        <div class="dropdown-menu" id="dropdownMenu">
          <!-- Campaigns will be loaded here -->
        </div>
      </div>
      
      <div class="selected-campaigns">
        <h4>Selected Campaigns (<span id="selectedCount" class="selected-count">0</span>)</h4>
        <div class="selected-list" id="selectedList">
          <div class="empty-selection">No campaigns selected</div>
        </div>
      </div>
    </div>

    <div style="margin: 20px 0;">
      <label for="mergedCampaignName">New Campaign Name:</label>
      <input type="text" id="mergedCampaignName" placeholder="Enter merged campaign name..." style="width: 100%; padding: 10px; margin-top: 8px; border: 2px solid #dee2e6; border-radius: 6px;">
    </div>
     <div class="merge-group">
      <label for="merged_campaign_description">Campaign Description (Optional)</label>
      <input type="text" id="merged_campaign_description" name="merged_campaign_description" placeholder="Describe this merged campaign..." style="width: 100%; padding: 10px; margin-top: 8px; border: 2px solid #dee2e6; border-radius: 6px;">
    </div>
    
    <div class="popup-buttons">
      <button class="btn-popup btn-popup-cancel" onclick="closeMergePopup()">Cancel</button>
      <button class="btn-popup btn-popup-merge" onclick="performMerge()" id="performMergeBtn" disabled>Merge Campaigns</button>
    </div>
  </div>
</div>
</body>
</html>