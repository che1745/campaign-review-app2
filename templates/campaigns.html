<!DOCTYPE html>
<html>
<head>
  <title>Campaigns</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    h2 {
      color: #2c3e50;
      margin: 0;
      font-size: 2.2em;
      font-weight: 600;
    }
    
    .upload-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      border: 2px solid #e9ecef;
    }
    
    .upload-title {
      font-size: 1.1em;
      font-weight: 600;
      margin-bottom: 15px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .upload-form {
      display: flex;
      gap: 12px;
      align-items: end;
      flex-wrap: wrap;
    }
    
    .form-group {
      flex: 1;
      min-width: 180px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #495057;
      font-size: 14px;
    }
    
    .form-group input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    
    .form-group input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      background: white;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .file-input-wrapper:hover {
      border-color: #667eea;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-input-text {
      color: #6c757d;
      font-size: 14px;
      pointer-events: none;
    }
    
    .upload-btn {
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    
    .upload-btn:hover {
      background: #5a67d1;
    }
    
    .upload-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .search-container {
      margin-bottom: 25px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .search-input {
      padding: 12px 20px;
      border: 2px solid #e9ecef;
      border-radius: 25px;
      font-size: 16px;
      flex: 1;
      max-width: 400px;
      transition: all 0.3s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .clear-btn {
      padding: 12px 20px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .clear-btn:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }
    
    .table-container {
      overflow-x: auto;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 25px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    td {
      padding: 15px;
      border-bottom: 1px solid #f8f9fa;
      font-size: 14px;
      vertical-align: middle;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: #e3f2fd;
      transform: scale(1.01);
      transition: all 0.2s;
    }
    
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      transition: all 0.3s;
    }
    
    .btn-view {
      background: linear-gradient(135deg, #74b9ff, #0984e3);
      color: white;
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #ff7675, #e17055);
      color: white;
    }
    
    .btn-send {
      background: linear-gradient(135deg, #00b894, #00a085);
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-approved {
      background: linear-gradient(135deg, #00b894, #00a085);
      color: white;
    }
    
    .status-pending {
      background: linear-gradient(135deg, #fdcb6e, #e17055);
      color: white;
    }
    
    .status-draft {
      background: linear-gradient(135deg, #fd79a8, #e84393);
      color: white;
    }
    
    .pagination {
      margin-top: 25px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
    
    .pagination button {
      padding: 10px 15px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      cursor: pointer;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.3s;
    }
    
    .pagination button:hover:not(:disabled) {
      background: #667eea;
      color: white;
    }
    
    .pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .pagination .current {
      background: #667eea;
      color: white;
    }
    
    .records-info {
      margin-bottom: 15px;
      color: #6c757d;
      font-size: 14px;
      font-weight: 500;
    }
    
    .no-results {
      text-align: center;
      padding: 60px;
      color: #6c757d;
    }
    
    .no-results h3 {
      color: #495057;
      margin-bottom: 10px;
    }
    
    .flash-messages {
      margin-bottom: 20px;
    }
    
    .flash-message {
      padding: 12px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-weight: 500;
    }
    
    .flash-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .flash-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .csv-help {
      background: #e9ecef;
      border-radius: 6px;
      padding: 12px;
      margin-top: 15px;
      font-size: 12px;
      color: #6c757d;
    }
    
    .csv-help h4 {
      margin: 0 0 8px 0;
      color: #495057;
      font-size: 13px;
    }
    
    .csv-help p {
      margin: 3px 0;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="flash-message flash-{{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="header">
      <h2>üìÅ Campaign Management</h2>
    </div>
    
    <!-- CSV Upload Section -->
    <div class="upload-section">
      <div class="upload-title">
        <span>üì§</span>
        Upload New Campaign
      </div>
      
      <form method="POST" action="{{ url_for('upload_csv') }}" enctype="multipart/form-data" class="upload-form" id="uploadForm">
        <div class="form-group">
          <label for="campaign_name">Campaign Name</label>
          <input type="text" id="campaign_name" name="campaign_name" placeholder="Enter campaign name..." required>
        </div>
        
        <div class="form-group">
          <label>CSV File</label>
          <div class="file-input-wrapper" onclick="document.getElementById('csv_file').click()">
            <input type="file" id="csv_file" name="csv_file" accept=".csv" required>
            <span class="file-input-text" id="fileText">Choose file...</span>
          </div>
        </div>
        
        <button type="submit" class="upload-btn" id="uploadBtn">
          <span>üìÅ</span>
          Upload
        </button>
      </form>
    </div>
    
    <!-- Search and Filter -->
    <div class="search-container">
      <input type="text" id="searchInput" class="search-input" placeholder="üîç Search campaigns by name, status..." />
      <button class="clear-btn" onclick="clearSearch()">Clear</button>
    </div>
    
    <div class="records-info">
      Showing <span id="recordsCount">0</span> campaigns
    </div>
    
    <!-- Campaigns Table -->
    <div class="table-container">
      <table id="campaignsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Campaign Name</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          {% for c in campaigns %}
          <tr>
            <td><strong>#{{ c[0] }}</strong></td>
            <td>{{ c[1] }}</td>
            <td>
              <span class="status-badge 
                {% if c[2] == 'approved' %}status-approved
                {% elif c[2] == 'pending' %}status-pending
                {% else %}status-draft{% endif %}">{{ c[2] }}</span>
            </td>
            <td>
              <div class="actions">
                <a href="{{ url_for('campaign_detail', campaign_id=c[0]) }}" class="btn btn-view">üë• View Profiles</a>
                <form method="POST" action="{{ url_for('delete_campaign', campaign_id=c[0]) }}" style="display:inline;">
                  <button type="submit" class="btn btn-delete" onclick="return confirm('‚ö†Ô∏è Are you sure you want to delete this campaign and all its profiles?')">üóëÔ∏è Delete</button>
                </form>
                {% if c[2] == 'approved' %}
                <form method="POST" action="{{ url_for('send_to_n8n', campaign_id=c[0]) }}" style="display:inline;">
                  <button type="submit" class="btn btn-send" onclick="return confirm('Send approved campaign?')">üöÄ Process</button>
                </form>
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      
      <div id="noResults" class="no-results" style="display: none;">
        <h3>No campaigns found</h3>
        <p>Try adjusting your search criteria or upload a new campaign</p>
      </div>
    </div>
    
    <!-- Pagination -->
    <div class="pagination" id="pagination">
      <button id="prevBtn" onclick="changePage(-1)">‚Üê Previous</button>
      <span id="pageInfo">Page 1 of 1</span>
      <button id="nextBtn" onclick="changePage(1)">Next ‚Üí</button>
    </div>
  </div>

  <script>
    let currentPage = 1;
    const recordsPerPage = 10;
    let filteredRows = [];
    let allRows = [];

    function initializeTable() {
      const tableBody = document.getElementById('tableBody');
      allRows = Array.from(tableBody.getElementsByTagName('tr'));
      filteredRows = [...allRows];
      updateDisplay();
    }

    function searchTable() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const tableBody = document.getElementById('tableBody');
      const rows = Array.from(tableBody.getElementsByTagName('tr'));
      
      filteredRows = rows.filter(row => {
        const text = row.textContent.toLowerCase();
        return text.includes(searchTerm);
      });
      
      currentPage = 1;
      updateDisplay();
    }

    function updateDisplay() {
      const startIndex = (currentPage - 1) * recordsPerPage;
      const endIndex = startIndex + recordsPerPage;
      const totalPages = Math.ceil(filteredRows.length / recordsPerPage);
      
      // Hide all rows
      allRows.forEach(row => row.style.display = 'none');
      
      // Show current page rows
      const currentRows = filteredRows.slice(startIndex, endIndex);
      currentRows.forEach(row => row.style.display = '');
      
      // Update pagination
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
      document.getElementById('pageInfo').textContent = totalPages > 0 ? `Page ${currentPage} of ${totalPages}` : 'Page 0 of 0';
      
      // Update records count
      document.getElementById('recordsCount').textContent = filteredRows.length;
      
      // Show/hide no results message
      const noResults = document.getElementById('noResults');
      const table = document.getElementById('campaignsTable');
      if (filteredRows.length === 0) {
        noResults.style.display = 'block';
        table.style.display = 'none';
      } else {
        noResults.style.display = 'none';
        table.style.display = 'table';
      }
    }

    function changePage(direction) {
      const totalPages = Math.ceil(filteredRows.length / recordsPerPage);
      const newPage = currentPage + direction;
      
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        updateDisplay();
      }
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      filteredRows = [...allRows];
      currentPage = 1;
      updateDisplay();
    }

    // File input handling
    document.getElementById('csv_file').addEventListener('change', function(e) {
      const fileName = e.target.files[0] ? e.target.files[0].name : 'Choose file...';
      document.getElementById('fileText').textContent = fileName;
    });

    // Form validation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      const campaignName = document.getElementById('campaign_name').value.trim();
      const csvFile = document.getElementById('csv_file').files[0];
      
      if (!campaignName) {
        alert('Please enter a campaign name');
        e.preventDefault();
        return;
      }
      
      if (!csvFile) {
        alert('Please select a CSV file');
        e.preventDefault();
        return;
      }
      
      if (!csvFile.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a valid CSV file');
        e.preventDefault();
        return;
      }
      
      // Show loading state
      const btn = document.getElementById('uploadBtn');
      btn.disabled = true;
      btn.innerHTML = '<span>‚è≥</span> Uploading...';
    });

    // Event listeners
    document.getElementById('searchInput').addEventListener('input', searchTable);
    document.getElementById('searchInput').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        searchTable();
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initializeTable);
  </script>
</body>
</html>